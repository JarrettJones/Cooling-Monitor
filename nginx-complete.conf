# nginx configuration for Firmware Checker and Cooling Monitor
# Generated: 2026-01-14
# Integrated configuration for both applications

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    sendfile        on;
    keepalive_timeout  65;
    
    # Logging
    access_log  logs/access.log;
    error_log   logs/error.log;
    
    # HTTP server - redirect to HTTPS
    server {
        listen 80;
        server_name dca20301103n414 localhost;
        
        # Redirect all HTTP to HTTPS
        return 301 https://$host$request_uri;
    }
    
    # HTTPS server
    server {
        listen 443 ssl;
        server_name dca20301103n414 localhost;
        
        # SSL Certificate Configuration
        # IMPORTANT: Use server-fullchain.crt (includes intermediate CA) for proper SSL validation
        # These paths will be updated by fix_ssl_certificate_chain.ps1
        ssl_certificate      C:/nginx/ssl/server-fullchain.crt;
        ssl_certificate_key  C:/nginx/ssl/server-new.key;
        
        # SSL Settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # Root redirects to firmware-checker
        location = / {
            return 301 /firmware-checker/;
        }
        
        # Firmware Checker application
        # Keep the /firmware-checker prefix when proxying
        location /firmware-checker {
            # Rewrite to strip /firmware-checker before passing to Flask
            rewrite ^/firmware-checker(.*)$ $1 break;
            
            # Proxy to Flask on port 5000 (use IPv4 explicitly to avoid IPv6 issues)
            proxy_pass http://127.0.0.1:5000;
            
            # Preserve original request information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # CRITICAL: Tell Flask about the /firmware-checker prefix
            # This makes url_for() generate correct URLs
            proxy_set_header X-Forwarded-Prefix /firmware-checker;
            proxy_set_header X-Script-Name /firmware-checker;
            
            # Performance optimizations
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Timeouts for long-running firmware checks
            proxy_connect_timeout 10s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
            
            # Disable buffering for faster responses
            proxy_buffering off;
            proxy_request_buffering off;
            
            # Enable keepalive
            keepalive_timeout 65;
        }
        
        # Cooling Monitor application
        location /cooling-monitor/ {
            # Don't strip the prefix - pass it through to FastAPI
            proxy_pass http://127.0.0.1:8000/cooling-monitor/;
            
            # Preserve original request information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Performance optimizations
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Timeouts
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # Disable buffering for faster responses
            proxy_buffering off;
        }
        
        # Cooling Monitor - WebSocket endpoint (CRITICAL for real-time updates)
        location /cooling-monitor/ws {
            # Pass through to FastAPI
            proxy_pass http://127.0.0.1:8000/cooling-monitor/ws;
            proxy_http_version 1.1;
            
            # WebSocket upgrade headers (REQUIRED)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Preserve original request information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Long timeout for WebSocket connections (24 hours)
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
        }
    }
}
